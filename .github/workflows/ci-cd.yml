name: CI-CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  IMAGE_NAME: autoserve-api
  PYTHON_VERSION: "3.12"

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --no-cache-dir -r requirements.txt

      - name: Run unit tests
	env:
          PYTHONPATH: .
        run: |
          pytest

      # ---- Optional quality/security hooks (you can talk about these) ----
      # - name: SonarQube / SonarCloud scan
      #   if: env.SONAR_TOKEN != ''
      #   env:
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      #   run: |
      #     echo "Here I would run sonar-scanner using SONAR_TOKEN"

      # - name: Snyk scan
      #   if: env.SNYK_TOKEN != ''
      #   env:
      #     SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      #   run: |
      #     echo "Here I would run 'snyk test' or 'snyk container test'"

  cd:
    needs: ci
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Docker login to ACR
        env:
          ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
          ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
        run: |
          echo "$ACR_PASSWORD" | docker login $ACR_LOGIN_SERVER \
            --username "$ACR_USERNAME" --password-stdin

      - name: Build and push image
        env:
          ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
        run: |
          IMAGE_TAG=${GITHUB_SHA::7}
          docker build -t $ACR_LOGIN_SERVER/${{ env.IMAGE_NAME }}:$IMAGE_TAG .
          docker push $ACR_LOGIN_SERVER/${{ env.IMAGE_NAME }}:$IMAGE_TAG

